\chapter{Sběr dat a komunikace komponent} \label{chap:dataCollection}
  Použitým algoritmům strojového učení je nutné dodat data sestávající z~posloupnosti hodnot příznaků (více v \refskl{chap:features}{kapitole}) a odpovídajících stavů žaluzií (výška vytažení a sklon lamel) v~daných časových okamžicích. Tato kapitola se zabývá metodami sběru dat v~jednotlivých součástech systému, přenosem z~nich a jejich vzájemnou komunikací.
  
  Data se získávají ze 3 hlavních zdrojů na základě požadavku zaslaného skriptem \file{mqttDataCollector.py}. Stav žaluzie a informaci, zda je uživatel přítomen v~domácnosti\footnote{příznaky \code{posi\-tion}, \code{tilt} a \code{home}} odesílá systém domácí automatizace \emph{Home Assistant}, měřené veličiny (teplota a intenzita osvětlení) uvnitř a venku pak příslušná zařízení \footnote{příznaky \code{lum\_in}, \code{lum\_out}, \code{temp\_in} a \code{temp\_out}} a ostatní informace o~počasí\footnote{rychlost (\code{owm\_wind\_speed}) a směr (\code{owm\_wind\_heading}) větru, předpověď teploty na $x=1,2,3$~h dopředu (\code{owm\_temp\_$x$h}) a předpověď nejvyšší denní teploty (\code{owm\_temp\_max})} se získávají přímo v~rámci skriptu \file{mqttData\-Collector.py} z~REST API \href{https://openweathermap.org/}{OpenWeather}. Data získaná z~komponent se pak v~jedné společné zprávě odesílají přes MQTT skriptu \file{mqtt2mongo.py}, který je uloží do databáze. Na \refskl{fig:comm}{obrázku} je přehled komponent, které se podílejí na sběru dat, a jejich komunikace včetně používaných protokolů.
  \begin{figure}
    \centering
    \input{img/comm.tex}
    \caption[Schéma komunikace komponent]{Schéma komunikace komponent. Obrázek znázorňuje vybrané komponenty sytému automatického řízení žaluzií, tok dat mezi nimi a komunikační protokoly. Plnou šipkou jsou propojené komponenty komunikující pomocí MQTT, přerušovanou pomocí HTTP a čerchovanou ty, které ke komunikaci využívají protokol pro komunikaci s~databázovým serverem MongoDB Wire}
    \label{fig:comm}
  \end{figure}
  \section{MQTT} \label{sec:MQTT}
    Protokol MQTT se využívá pro veškerou komunikaci součástí při sběru dat. Centrální uzel se nazývá broker a jedná se o~software spuštěný na RPi1 (\cref{sec:rpi}) na výchozím TCP portu 1883. Připojují se k~němu všechny komponenty, které využívají MQTT. Po připojení mohou publikovat zprávy do hirerchicky uspořádaných témat a přihlašovat se k~jejich odběru, broker pak zajistí doručení zpráv publikovaných v~určitém tématu klientům, kteří jsou přihlášeni k~jeho odběru.
    
    Při sběru dat se periodicky nebo na základě změny stavu žaluzie odešle do tématu \code{smart\-blinds/command} zpráva ve formátu JSON, která obsahuje pod klíčem \uv{\emph{command}} hodnotu \uv{\emph{request\_values}}. K~odběru tohoto tématu jsou přihlášena obě zařízení s~ESP8266 i systém domácí automatizace a po jejím přijetí odešlou aktuální hodnoty jimi sledovaných příznaků do odpovídajích témat dle \refskl{tab:topics}{tabulky}. Všechna tato témata odebírá skript \file{mqttDataCollec\-tor.py}, který hodnoty příznaků společně s~časovou známkou odesílá v~jedné zprávě, která dále obsahuje informaci o~tom, zda je aktivní testovací režim využívaný při vývoji, do tématu \code{smart\-blinds/da\-ta}. To odebírá skript \file{broker\-2mongo.py} popsaný v~\refskl{sec:db}{sekci}.
  \input{tab/tab_topics.tex}
  \section{REST API výrobce pohonu žaluzie}
    Komunikace s~aplikačním rozhraním je šifrovaná a probíhá pomocí protokolu HTTPS zasíláním požadavků na \emph{endpointy} serverů výrobce dostupné na adrese \href{https://api.somfy.com/api/v1/}{https://api.somfy.com/api/v1/}. Použitý systém domácí automatizace i backend vyvíjeného systému používají ke komunikaci s~API knihovnu Pymfy, která mapuje akce pro manipulaci se žaluzií a její stav na metody a proměnné objektu v~jazyce python, který je tak modelem žaluzie. Dále zpřístupňuje některé obecnější metody pro práci s~API jako je například zjištění všech montáží zákazníka, zjištění všech dostupných zařízení v~rámci konkrétní montáže atd.

    Jednotlivé požadavky se autorizují na základě krátkodobého tokenu s~platností 1~h. Pokud vyprší jeho platnost, je nutné pomocí obnovovacího tokenu ze serveru získat nový a přikládat ho k~budoucím požadavkům. Oba tokeny se získávají pomocí OAuth2 metodou \uv{Authorization Code Grant}, z~důvodů odlišností od dokumentace v~implementaci Somfy se ale ani po kontaktování technické podpory nepodařilo získat nové přístupové údaje k~API a tak muselo být využito nedokumentovaného postupu k~jejich získání. Přestože jsou tokeny v~obou systémech odvozené od stejných přístupových údajů, zdají se být nezávislé (včetně kvóty na četnost požadavků) a na funkčnost to tedy nemá vliv. Hledání tohoto postupu se zdálo být časově nákladné a proto se ke zjišťování aktuálního stavu žaluzií využívá právě systém domácí automatizace.

    Běžně je nutné si na webových stránkách na adrese \href{https://develeoper.somfy.com}{https://developer.som\-fy.com} vytvořit tzv. aplikaci pod uživatelským účtem, ke kterému je technikem při instalaci žaluzií přiřazena konkrétní montáž. Na základě zadaného názvu, \emph{callback \acrshort{url}}\footnote[1]{Návratová \acrshort{url} v~rámci vyvíjené aplikace, na kterou se přesměruje webový prohlížeč uživatele po úspěšné autorizaci, prostřednictvím parametrů se aplikaci předá kód, na základě kterého může získat tokeny} a popisu aplikace se získájí dva řetězce: \emph{Consumer key} a \emph{Consumer secret}.\cite{somfy:api} Ty se pak společně s~\emph{callback \acrshort{url}}\footnotemark[1] předají konstruktoru objektu, který v~rámci knihovny Pymfy reprezentuje API.\cite{tetienne:pymfy}

    Takto vytvořené \emph{Consumer key} a \emph{Consumer secret} se však nedařilo použít, server Somfy je totiž zamítal. Byla tedy kontaktována technická podpora, ale ani po několika týdnech se nedostavila odpověď. Mezitím pokračovaly pokusy o~získání tokenu jinak. Pro systém domácí automatizace, který se se žaluziemi již používal, existovaly tyto údaje a ukázalo se, že jsou funkční. Místo správné \emph{callback \acrshort{url}} se tedy do konstruktoru zadala ta, která příslušela k~aplikaci ve vývojářském portálu, a byl zahájen proces získání tokenů. Po přesměrování zpět se v~adresním řádku prohlížeče ručně změnila adresa tak, aby odpovídala endpointu vytvořenému k~získávání a ukládání tokenů v~rámci backendu. Pokud by bylo možné postupovat standardním způsobem, po přihlášení na stránkách Somfy by byl prohlížeč přesměrován právě na tuto adresu. Tokeny se tak uložily do souboru \file{somfycache} pro pozdější použití.

    Data a služby, které API poskytuje jsou využívány ke dvěma účelům. Jednak systém domácí automatizace každou minutu kontroluje aktuální stav žaluzií a pokud se změní, odešle novou hodnotu přes MQTT a spustí tak posloupnost akcí (popsanou v~\refskl{sec:MQTT}{sekci}), které vedou k~vytvoření nového záznamu v~databázi, druhak stránka \uv{Control} v~\acrshort{gui} umožňuje zobrazit aktuální stav žaluzií a zadávat příkazy k~jeho změně. Samotnou komunikaci s~API zajišťuje backend systému, se kterým se komunikuje přes protokol WebSockets. Po připojení alespoň jednoho klienta se každých 15~s~zjistí stav žaluzie a připojeným prohlížečům se odešle zpráva ve formátu JSON. Její struktura je uvedená v~\refskl{lst:wsMsg}{úryvku kódu}. Naopak po přijetí zprávy backendem se v~závislosti na jejím obsahu odešle požadavek API na změnu stavu žaluzie. Zpráva má stejnou strukturu jako zpráva v~\refskl{lst:wsMsg}{úryvku kódu}, ale obsahuje jen jeden z~klíčů. Navíc může obsahovat speciální klíč \code{testing} s hodnotou datového typu \code{boolean}\footnote{\code{boolean} je datový typ, který vyjadřuje pravdivostní hodnotu.}, pomocí kterého lze měnit příznak \code{testing} dat ukládaných do databáze, který slouží k~rozlišení akcí vyvolaných při vývoji v~rámci testování a skutečných akcí, které má systém napodobovat. Zpráva o~změně režimu se v~tomto případě odešle přes MQTT skriptu \file{mqttDataCollector.py}, který příznak zaznamenává k~datům. Zprávy se odesílají na základě interakce uživatele s~ovládacími prvky \acrshort{gui}.

    \begin{lstlisting}[caption={[Struktura zprávy o~stavu žaluzie]Struktura zprávy o~stavu žaluzie, která je všem klientům zasílána každých 15~s. \code{position} označuje výšku vytažení žaluzie (0 -- zavřeno, 100 -- otevřeno), obdobně hodnota \code{tilt} vyjadřuje naklopení lamel.},captionpos=b,label=lst:wsMsg]
      {
        "position": int
        "tilt": int
      }
    \end{lstlisting}

  \section{OpenWeather API} \label{sec:owm}
    Skript \file{mqttDataCollector.py} kromě měřených příznaků a stavu žaluzií zjišťuje také odhad počasí a jeho předpověď. Tato data poskytuje společnost OpenWeather prostřednictvím svého API, které má několik možností využití. Z~důvodu jednoduchosti byla pro přístup k~API zvolena knihovna PyOWM, která používá variantu \uv{One-Call}. Na základě jednoho požadavku se tak získá aktuální počasí, předpověď po minutách na následující hodinu, předpověď po hodinách na následující 2 dny, předpověď po dnech na následující týden, výstrahy vydané \acrshort{chmu} a historická data z~posledních 5 dnů, vše je pak přístupné pomocí atributů a metod objektu v~Pythonu. K~požadavku je vždy připojen klíč, který byl bezplatně získán po registraci na \href{https://openweathermap.org}{webových stránkách https://openweathermap.org}. Limity četnosti požadavků stanovené poskytovatelem jsou vyšší než 1 požadavek za 5 minut. Jako příznaků se využívá kódu počasí (vyjadřuje jeho shrnutí -- např. slunečno, polojasno, déšť, jasná noc \acrshort{atp}), rychlosti a směru větru, předpovědi teploty na následující 3 hodiny a předpovědi nejvyšší denní teploty.

  \section{Databáze}\label{sec:db}
    Data, která se sbírají v~pětiminutových intervalech a na základě změny stavu žaluzie pomocí skriptu \file{mqttDataCollector.py}, ukládá skript \file{broker\-2mongo.py} do databáze MongoDB. Jednotlivé vzorky jsou získávány z~MQTT zpráv zasílaných do tématu \code{smartblinds/data} a ukládají se ve stejné podobě jako příchozí zpráva. Struktura je uvedena v~\refskl{lst:datum}{úryvku kódu}.

    \begin{lstlisting}[caption={[Struktura vzorku v~databázi]Struktura vzorku dat uloženého jako záznam v~databázi MongoDB. Obsahuje hodnoty příznaků i stav žaluzií v~okamžiku jeho pořízení a časovou známku. Místo hodnot jsou zde uvedeny jejich datové typy (\code{float} - číslo s plovoucí řádovou čárkou, \code{boolean} - pravdivostní hodnota, \code{int} - celé číslo)},captionpos=b,label=lst:datum]
      {
        "timestamp": float,
        "testing": boolean,   
        "periodical": boolean,
        "features": {
          "year_day": int,
          "week_day": int,
          "day_secs": int,
          "home": boolean,
          "temp_in": float,
          "temp_out": float,
          "lum_in": float,
          "lum_out": float,
          "owm_temp_max": float,
          "owm_temp_1h": float,
          "owm_temp_2h": float,
          "owm_temp_3h": float,
          "owm_code": int,
          "owm_wind_speed": float,
          "owm_wind_heading": float
        },
        "targets": {
          "position": int,         
          "tilt": int
        }
      }
    \end{lstlisting}

    Uložená data se využívají při strojovém učení modelů, ve vizualizaci dat na stránce \uv{Live} v~\acrshort{gui} a v~porovnání skutečného řízení a řízení jednotlivých regresorů tamtéž. Také se zobrazují v~tabulce na stránce \uv{Data}.

  \section{Webserver}
    Systém má webové uživatelské rozhraní získávané z~\emph{Next.js} serveru. Data a služby mu poskytuje HTTP backend implementovaný v~Pythonu pomocí frameworku Tornado, který tak tvoří rozhraní mezi \acrshort{gui} a databází, všemi regresory (predikce, simulace i učení) a Somfy API. Přímo klientský prohlížeč vykonává požadavky na endpointy backendu, tedy: 
    \begin{itemize}
      \item \code{ep\_data}, který poskytuje data z~databáze na základě \code{POST} požadavku s~volitelnými JSON parametry (\code{ts\_start} a \code{ts\_end}) v~těle označujícími časovou známku začátku a konce intervalu, vrací seznam vzorků (\cref{lst:datum}) pod klíčem \code{data} ve formátu JSON jako tělo odpovědi,
      \item \code{ep\_control}, který slouží k~predikci řízení jednoho z~regresorů (parametr \code{classifier\_name} na základě hodnot příznaků předaných jako JSON parametr \code{features}, vrací dobu trvání predikce (\code{controlTime}), \code{status: ok} a navržené hodnoty řízení (jako v~\refskl{lst:wsMsg}{úryvku kódu}),
      \item \code{ep\_train} \textcolor{red}{TODO: Doplnit po zprovoznění},
      \item \code{ep\_predict}, který přijímá začátek a konec intervalu stejným způsobem jako \code{ep\_data} a seznam názvů regresorů v~parametru \code{classifiers}. Pro každý z nich vrací pod klíčem s~jejich názvem dvojici seznamů časových známek a uspořádaných dvojic hodnot řízení doporučených daným regresorem a 
      \item \code{ws}, který zjišťuje spojení pomocí protokolu WebSockets pro pravidelnou aktualizaci vizualizace stavu žaluzií a pro přenos požadavků na jeho změnu.
    \end{itemize}
    
    
    \begin{figure}
      \centering
      \input{img/endpoints.tex}
      \caption[Schéma endpointů a přenášených struktur]{Schéma endpointů a přenášených struktur. Obrázek znázorňuje endpointy backendu systému pro automatické ovládání žaluzií a datové struktury přenášené v~těle jednotlivých  požadavků a odpovědí. Zobrazuje také použitou metodu požadavků, v~posledním případě se nejedná o~metodu HTTP ale o~protokol WebSockets.}
      \label{fig:endpoints}
    \end{figure}