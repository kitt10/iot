\chapter{Regresory} \label{chap:regresory}
    Při řízení žaluzií je nutné automaticky generovat akční zásahy. Regresory slouží právě k tomuto účelu, pro vzorek sestávající z určitého počtu (který se odvíjí od architektury konkrétního regresoru) příznakových vektorů vrací hodnoty doporučeného nastavení žaluzií, které by mělo co nejlépe odpovídat požadavkům uživatele. V práci jsou použity 3 regresory nazvané \uv{If-else}, \uv{FFNN} a \uv{LSTM} s různými principy. Tato kapitola se zabývá jejich návrhem, specifickými vlastnostmi, které z něj vyplývají, a jeho metodami.
    
    Poslední dva zmíněné regresory využívají ke generování výstupu neuronových sítí (\acrshort{nn}). K práci s jejich modely bylo využíváno rozharní Keras v jazyce Python, které umožňuje jejich učení, vyhodnocování i následné použití pro regresi (\cite{keras:doc}). Při volbě jejich vnitřní struktury a parametrů učení se slepě zkoušely natrénovat sítě se všemi možnými kombinacemi určitých parametrů a následně se vybrala nejlepší z nich ve smyslu minimální střední kvadratické odchylky na testovací datové sadě (\cref{ssec:test}). Parametry a prohledávané hodnoty jsou uvedeny v \refskl{sec:ffnn,sec:lstm}{sekcích}.

    Všechny regresory mají jednotné rozhraní a jimi doporučené řízení poskytují prostřednictvím metod \code{control()} a \code{predict()}. První z nich je určena pro jednotlivé vzorky, druhá pak pro jejich seznam. Obě se volají při obsluhování příslušných požadavků z uživatelského rozhraní při použití Simulátoru (\cref{sec:sim}) nebo grafu řízení na záložce Live (\cref{sec:live}). Metoda \code{predict()} se od metody \code{control()} liší tím, že u regresorů, které využívají \acrshort{nn}, se celá vstupní data zpracovávají najednou, což má pozitivní vliv na rychlost. Kvůli architektuře použité knihovny Keras je ale nutné mít správně nastavený počet přijímaných vzorků ve vstupní vrstvě modelu, proto se při každém požadavku odvozuje nový model. Ten má stejné vnitřní parametry jako původní a poskytuje tak pro daná data stejné výsledky.
    
    Přetrénování regresorů založených na \acrshort{nn} je možné spustit pomocí metody \code{train()} na předaných datech.
    \section{Regresor založený na pravidlech (If-else)}
        Základní regresor \uv{If-else} tvoří výstup deterministicky na základě pravidel vyjádřených ve formě zřetězených konstrukcí if-elif-else (odtud tedy název) v programovacím jazyku Python. Slouží k porovnání dále navržených metod s přístupem v domácí automatizaci, který se v současnosti v praxi používá častěji (\cite{apple:home}, \cite{openhab:openhab}, \cite{hass:hass}), tedy rozhodování dle neměnných pravidel.

        Pravidla byla konstruována podle slovy formulovaných požadavků uživatele na stav žaluzií v závislosti na aktuálních podmínkách (vyjádřených příznakovým vektorem) s ohledem na to, že konkrétní parametry může být nutné změnit, protože je uživatel není schopen přesně definovat, nastavují se proto v konfiguračním souboru \file{cfg\_ifelse.yml}. Formulována byla tato pravidla pro výšku vytažení žaluzie:
        \begin{enumerate}
            \item Ve dne\footnote{Den znamená, že je vnější intenzita osvětlení vyšší než nastavená mez a zároveň je čas vyšší než nastavený čas vstávání v daný den týdne. Jinak je noc.}:
            \begin{enumerate}
                \item Během jara a podzimu\footnote{Jaro a podzim jsou dny v roce z intervalů $\left\langle 80, 134\right\rangle \cup  \left\langle 274, 320\right\rangle $}: Je-li chladno\footnote{Chladno znamená, že je teplota venkovního vzduchu nižší než nastavená mez. Zvolena byla podle zkušenosti s vytápěním použitého domu na 10$^\circ$C.}, žaluzie má být vytažená, jinak v případě střední teploty\footnote{Střední teplota znamená že je teplota venkovního vzduchu v intervalu mezi zmíněnou mezí pro \uv{chladno} a další nastavitelnou mezí, která byla zvolena na 18$^\circ$C.} se má rozhodovat na základě rozdílu mezi teplotami předpovězenými za 2 a 1~hodinu (růst teploty). Pokud je růst teploty v nastaveném pásmu nebo vyšší nebo je teplota vnějšího vzduchu vyšší než obě meze, žaluzie má být ve stejné pozici jako by bylo léto (následující bod), v případě růstu nižšího se má vytáhnout.\footnote{Nižší hranice pásma byla zvolena na $-1{,}5~^\circ \mathrm{C}$, vyšší pak na $1{,}5~^\circ \mathrm{C}$.}
                \item V létě\footnote{Léto jsou dny v roce z intervalu $\left\langle 135, 273\right\rangle$}: Pokud to dovolují podmínky a uživatel je doma, žaluzie má být vytažená, jinak zatažená. Podmínky vhodné pro vytažení žaluzie jsou takové, kdy nehrozí přehřátí interiéru - rozdíl azimutu slunce a azimutu směru kolmého na žaluzii (směrem od domu) v absoultní hodnotě je vyšší než 90$^\circ$ nebo je předpovězená nejvyšší denní teplota nižší, než nastavená mez (například z důvodu oblačnosti, deště \acrshort{atp}).
                \item V zimě\footnote{Zima jsou ostatní dny, tedy dny v roce z intervalů $\left\langle 321, 366\right\rangle \cup \left\langle 1, 79\right\rangle $}: Žaluzie má být vytažená.
            \end{enumerate}
            \item V noci v kterémkoli období má být žaluzie zatažená.
        \end{enumerate}
        Kromě pravidel pro výšku vytažení byla formulována také pravidla pro míru naklopení:
        \begin{enumerate}
            \item Přes den:
            \begin{enumerate}
                \item Během jara a podzimu: V případě potřeby (vysoká intenzita osvětlení venku a zároveň alespoň vysoká teplota vzduchu uvnitř nebo teplota venkovního vzduchu, vše vzhledem k nastavitelným mezím) se má žaluzie naklopit jako by bylo léto, jinak mají být její lamely vodorovně.
                \item Během léta se má žaluzie naklopit o nejmenší možný úhel vzhledem k vodorovné rovině tak, aby zabránila (je-li to vzhledem k vzájemné poloze Slunce a žaluzie nutné) průchodu přímého slunečního záření oknem. Jestliže je ale intenzita osvětlení nižší než nastavená mez (vlivem počasí, nebo času), mají být lamely žaluzie vodorovně.
                \item V zimě je žaluzie vytažená a úhel naklopení nemá smysl uvažovat, z konstrukce bude žaluzie vodorovně.
                \item V případě, že uživatel není doma, naklopení žaluzie (jiné než vodorovné) má odpovídat $\frac{8}{10}$ jinak definovaného naklopení.
            \end{enumerate}
            \item V noci: Žaluzie úplně naklopená, vyjímkou je případ, kdy je vnitřní teplota nižší než nastavená mez - to může znamenat, že se uživatel snaží větrat a je tak vhodné žaluzie otevřít jen tak, aby mezi lamelami mohl lépe proudit vzduch, ale i přes to bránily průchodu světla pod malými úhly (po ulici projíždějící auta \acrshort{atp}).
        \end{enumerate}

        Z návrhu vyplývá, že se tento regresor nepřizpůsobuje novým návykům uživatele, protože využívá v čase neměnných pravidel. Některá pravidla mají volitelné parametry, které lze ladit a dosáhnout tak přesněji uživatelem požadovaných výsledků. 
    \section{Regresor využívající dopřednou neuronovou síť (FFNN)} \label{sec:ffnn}
        První regresor založený na neuronových sítích byl nazvaný \uv{FFNN} podle anglického sousloví \emph{\acrlong{ffnn}}, které označuje dopřednou neuronovou síť, využívanou tímto regresorem. Při volbě její vnitřní struktury byly prohledávány všechny kombinace hodnot parametrů uvedených v \refskl{tab:ffnnhyper}{tabulce}.
        \input{tab/tab_ffnnhyper.tex}
        Všechny vrstvy sítě jsou plně propojené. Neurony v nich využívají aktivační funkci ReLU, kromě výstupní vrstvy, která je aktivována funkcí sigmoid (obě funkce jsou popsané v \refskl{ssec:activationFcn}{sekci}), která je omezená shora i zdola a výstup vynásobený koeficientem je tak možné přímo použít jako případný akční zásah.
    \section{Regresor využívající rekurentní neuronovou síť (LSTM)} \label{sec:lstm}
        Tento regresor využívá rekurentní neuronovou síť zvanou \emph{\acrlong{lstm}} (\acrshort{lstm}, \cref{ssec:rnn}). Vnitřní struktura byla volena na základě výsledků prohledávání parametrů (popsáno v úvodu \hyperref[chap:regresory]{této kapitoly}), prohledávané hodnoty každého z nich jsou uvedené v \refskl{tab:lstmhyper}{tabulce}.
        \input{tab/tab_lstmhyper.tex}
        Aktivační funkcí je v tomto případě ve všech vrstvách hyperbolický tangens a funkce sigmoid pro rekurentní krok. Výstupní vrstva je stejná jako v případě \acrshort{nn} regresoru FFNN.
        
    \section{Příprava dat pro strojové učení}
        Naměřená data jsou uložená v databázi (\cref{chap:dataCollection}) ve svých původních jednotkách a jednotlivě podle okamžiku pořízení. Pro jejich využití při strojovém učení byla data načtená z databáze přeškálována a vytvořily se z nich vzorky dle architektury jednotlivých \acrshort{nn}. Vzorky byly náhodně a disjunktně rozděleny do 3 datových sad (trénovací, validační a testovací) v poměru 8:1:1. Výše popsané činnosti vykonával skript \file{mongo2h5.py}, který na závěr 3 datové sady pro každou síť uložil do souboru pro pozdější využití.
        
        Hodnoty jednotlivých veličin byly převedeny do intervalu $\left\langle 0,1\right\rangle$ posunutím a škálováním jejich očekávaného intervalu uvedeného v \refskl{tab:features}{tabulce} v \refskl{chap:features}{kapitole}. Pro regresor FFNN každý vzorek v datových sadách odpovídal jednomu naměřenému vzorku, zatímco pro regresor LSTM každý obsahoval příznaky ze 64 časových okamžiků a požadované hodnoty nastavení žaluzie pro poslední z nich. Uložený soubor s datovými sadami byl ve formátu h5 a jeho název obsahoval informaci o časovém intervalu, ze kterého data v něm pochází, a o architektuře \acrshort{nn}, pro kterou je určen.

        \paragraph{Trénovací datovou sadu} tvoří 80\% náhodně vybraných vzorků a při trénování jsou její vzorky po dávkách předkládány \acrshort{nn}. V každém kroku je pro ně vyhodnocována ztrátová funkce, jejíž hodnoty slouží k nastavení vnitřních parametrů učicím algoritmem.
        \paragraph{Validační datovou sadu} tvoří 10\% náhodně vybraných vzorků. V každém kroku učení se na ní vyhodnocuje několik metrik. Není na ní závislé učení \acrshort{nn} a je tak možné ověřit, zda síť dobře zobecňuje.
        \paragraph{Testovací datová sada} sestává ze zbylých 10\% vzorků, které neobsahuje ještě žádná z datových sad. Byla použita pro vyhodnocení úspěšnosti učení sítí s různou strukturou při hledání té nejvhodnější (\cref{sec:ffnn,sec:lstm}).
            \label{ssec:test}